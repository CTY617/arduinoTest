const int buttonPin = 4;
const int redPin = 5;
const int greenPin = 7;
const int bluePin = 6;

unsigned long lastChange = 0;
unsigned long interval = 2000; // 初始為 2 秒
int mode = 0; // 0=輪播, 1=黃閃爍, 2=紅閃爍
bool blinkState = false;

bool lastButtonState = HIGH;
bool currentButtonState = HIGH;

void setup() {
  pinMode(buttonPin, INPUT_PULLUP);
  pinMode(redPin, OUTPUT);
  pinMode(greenPin, OUTPUT);
  pinMode(bluePin, OUTPUT);

  allOff();
}

void loop() {
  currentButtonState = digitalRead(buttonPin);

  // 長按：直接熄滅
  if (currentButtonState == LOW && lastButtonState == LOW) {
    allOff();
    return;
  }

  // 按一下切換模式（HIGH → LOW）
  if (lastButtonState == HIGH && currentButtonState == LOW) {
    mode = (mode + 1) % 3;
    lastChange = millis(); // 重設時間
    blinkState = false;    // 重設閃爍狀態
  }

  // 根據模式執行
  unsigned long now = millis();
  if (mode == 0) {
    interval = 2000;
    if (now - lastChange >= interval) {
      lastChange = now;
      int state = (now / interval) % 3;
      setColorByState(state);
    }
  } else if (mode == 1) {
    interval = 500;
    if (now - lastChange >= interval) {
      lastChange = now;
      blinkState = !blinkState;
      if (blinkState) {
        setColorByState(1); // 黃
      } else {
        allOff();
      }
    }
  } else if (mode == 2) {
    interval = 500;
    if (now - lastChange >= interval) {
      lastChange = now;
      blinkState = !blinkState;
      if (blinkState) {
        setColorByState(2); // 紅
      } else {
        allOff();
      }
    }
  }

  lastButtonState = currentButtonState;
  delay(10); // 去彈跳
}

void setColorByState(int s) {
  switch (s) {
    case 0: // 綠
      digitalWrite(redPin, HIGH);
      digitalWrite(greenPin, LOW);
      digitalWrite(bluePin, HIGH);
      break;
    case 1: // 黃 = 紅 + 綠
      digitalWrite(redPin, LOW);
      digitalWrite(greenPin, LOW);
      digitalWrite(bluePin, HIGH);
      break;
    case 2: // 紅
      digitalWrite(redPin, LOW);
      digitalWrite(greenPin, HIGH);
      digitalWrite(bluePin, HIGH);
      break;
  }
}

void allOff() {
  digitalWrite(redPin, HIGH);
  digitalWrite(greenPin, HIGH);
  digitalWrite(bluePin, HIGH);
}
